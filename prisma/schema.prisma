generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model account {
  id                    String    @id @db.VarChar(36)
  accountId             String    @db.Text
  providerId            String    @db.Text
  userId                String    @db.VarChar(36)
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime? @db.DateTime(0)
  refreshTokenExpiresAt DateTime? @db.DateTime(0)
  scope                 String?   @db.Text
  password              String?   @db.Text
  createdAt             DateTime  @db.DateTime(0)
  updatedAt             DateTime  @db.DateTime(0)
}

model invitation {
  id             String   @id @db.VarChar(36)
  organizationId String   @db.VarChar(36)
  email          String   @db.Text
  role           String?  @db.Text
  status         String   @db.Text
  expiresAt      DateTime @db.DateTime(0)
  inviterId      String   @db.VarChar(36)
}

model jwks {
  id         String   @id @db.VarChar(36)
  publicKey  String   @db.Text
  privateKey String   @db.Text
  createdAt  DateTime @db.DateTime(0)
}

model member {
  id             String   @id @db.VarChar(36)
  organizationId String   @db.VarChar(36)
  userId         String   @db.VarChar(36)
  role           String   @db.Text
  createdAt      DateTime @db.DateTime(0)
}

model organization {
  id        String   @id @db.VarChar(36)
  name      String   @db.Text
  slug      String   @unique(map: "slug") @db.VarChar(255)
  logo      String?  @db.Text
  createdAt DateTime @db.DateTime(0)
  metadata  String?  @db.Text
}

model session {
  id                   String   @id @db.VarChar(36)
  expiresAt            DateTime @db.DateTime(0)
  token                String   @unique(map: "token") @db.VarChar(255)
  createdAt            DateTime @db.DateTime(0)
  updatedAt            DateTime @db.DateTime(0)
  ipAddress            String?  @db.Text
  userAgent            String?  @db.Text
  userId               String   @db.VarChar(36)
  impersonatedBy       String?  @db.Text
  activeOrganizationId String?  @db.Text
}

model user {
  id                  String             @id @db.VarChar(36)
  name                String             @db.Text
  email               String             @unique(map: "email") @db.VarChar(255)
  emailVerified       Boolean
  image               String?            @db.Text
  createdAt           DateTime           @db.DateTime(0)
  updatedAt           DateTime           @db.DateTime(0)
  username            String?            @unique(map: "username") @db.VarChar(255)
  role                String             @default("user") @db.VarChar(100)
  banned              Boolean?
  banReason           String?            @db.Text
  banExpires          DateTime?          @db.DateTime(0)
  displayUsername     String?            @db.Text
  lastLogin           DateTime?          @db.DateTime(0)
  channel_memberships channel_member[]
  event_created       event[]            @relation("event_created_by")
  event_updated       event[]            @relation("event_updated_by")
  faq_created         faq[]              @relation("faq_created_by")
  faq_updated         faq[]              @relation("faq_updated_by")
  gamesCreated        game[]             @relation("GameCreatedBy")
  gamesUpdated        game[]             @relation("GameUpdatedBy")
  game_session        game_session[]
  guild               guild[]
  guild_memberships   guild_member[]
  messages            message[]
  message_reactions   message_reaction[]
  message_reads       message_read[]
  room                room[]
  room_participations room_participant[]
  room_view           room_view[]
  user_settings       user_settings?
}

model verification {
  id         String    @id @db.VarChar(36)
  identifier String    @db.Text
  value      String    @db.Text
  expiresAt  DateTime  @db.DateTime(0)
  createdAt  DateTime? @db.DateTime(0)
  updatedAt  DateTime? @db.DateTime(0)
}

model sidelink {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  url       String   @db.VarChar(100)
  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @default(now()) @db.DateTime(0)
  createdBy String   @db.VarChar(36)
  updatedBy String   @db.VarChar(36)
  hidden    Boolean  @default(false)

  @@index([createdBy], map: "sidelink_user_FK")
  @@index([updatedBy], map: "sidelink_user_FK_1")
}

model username_file_config {
  id          Int     @id @default(autoincrement()) @db.UnsignedInt
  folder_slug String? @db.VarChar(100)
  path        String? @db.VarChar(200)
  variable    String? @db.VarChar(200)
  config_type String? @db.VarChar(100)
}

model user_settings {
  id              Int    @id @default(autoincrement())
  user_id         String @unique @db.VarChar(36)
  local_games_dir String @db.Text
  user            user   @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model game_session {
  id            String    @id @default(uuid()) @db.Char(36)
  user_id       String    @db.VarChar(36)
  game_slug     String    @db.VarChar(36)
  start_time    DateTime  @db.DateTime(0)
  end_time      DateTime? @db.DateTime(0)
  total_seconds Int?
  user          user      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], map: "game_session_user_id_fkey")
}

model event {
  id          String   @id @default(uuid()) @db.Char(36)
  name        String   @db.VarChar(255)
  description String?  @db.Text
  url         String?  @db.VarChar(500)
  start_time  DateTime @db.DateTime(0)
  end_time    DateTime @db.DateTime(0)
  created_at  DateTime @default(now()) @db.DateTime(0)
  updated_at  DateTime @default(now()) @updatedAt @db.DateTime(0)
  created_by  String   @db.VarChar(36)
  updated_by  String   @db.VarChar(36)
  location    String?  @db.VarChar(255)
  image_url   String?  @db.Text
  creator     user     @relation("event_created_by", fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updater     user     @relation("event_updated_by", fields: [updated_by], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([created_by], map: "event_created_by_FK")
  @@index([updated_by], map: "event_updated_by_FK")
  @@index([start_time], map: "event_start_time_IDX")
  @@index([end_time], map: "event_end_time_IDX")
}

model global_settings {
  id         Int      @id @default(autoincrement())
  key        String   @unique @db.VarChar(100)
  value      String?  @db.Text
  created_at DateTime @default(now()) @db.DateTime(0)
  updated_at DateTime @default(now()) @updatedAt @db.DateTime(0)
  created_by String   @db.VarChar(36)
  updated_by String   @db.VarChar(36)

  @@index([created_by], map: "global_settings_user_FK")
  @@index([updated_by], map: "global_settings_user_FK_1")
}

model game {
  id                String    @id @default(uuid()) @db.Char(36)
  size_gb           Float
  title             String    @db.VarChar(255)
  folder_slug       String    @unique @db.VarChar(100)
  version           String?   @db.VarChar(50)
  genres            String    @db.Text
  platforms         String?   @db.Text
  game_modes        String    @db.Text
  is_featured       Boolean   @default(false)
  date_updated      DateTime? @db.Date
  date_added        DateTime? @db.Date
  editor_name       String?   @db.VarChar(255)
  main_process_name String?   @db.VarChar(255)
  cover             String?   @db.Text
  logo              String?   @db.Text
  screenshots       String    @db.Text
  description       String?   @db.Text
  start_command     String?   @db.Text
  max_players       Int
  use_notifications Boolean   @default(true)
  created_at        DateTime  @default(now()) @db.DateTime(0)
  updated_at        DateTime  @default(now()) @updatedAt @db.DateTime(0)
  created_by        String    @db.VarChar(36)
  updated_by        String    @db.VarChar(36)
  createdBy         user      @relation("GameCreatedBy", fields: [created_by], references: [id])
  updatedBy         user      @relation("GameUpdatedBy", fields: [updated_by], references: [id])

  @@index([created_by], map: "game_user_created_FK")
  @@index([updated_by], map: "game_user_updated_FK")
  @@index([folder_slug], map: "game_folder_slug_IDX")
}

model role {
  name                          String  @id @unique @db.VarChar(100)
  nameplate_decoration_animated String? @db.Text
  nameplate_decoration_static   String? @db.Text
  avatar_decoration_animated    String? @db.Text
  avatar_decoration_static      String? @db.Text
}

model user_game {
  user_id      String    @db.VarChar(36)
  game_slug    String    @db.VarChar(100)
  installed_at DateTime? @db.DateTime(0)

  @@id([user_id, game_slug])
  @@index([user_id], map: "user_game_user_id_FK")
  @@index([game_slug], map: "user_game_game_slug_FK")
  @@index([game_slug, installed_at], map: "user_game_slug_installed_at_idx")
}

/// ====== FAQ ======
model faq {
  id         Int      @id @default(autoincrement())
  question   String   @db.VarChar(500)
  answer     String   @db.Text
  published  Boolean  @default(true)
  position   Int      @default(0)
  created_at DateTime @default(now()) @db.DateTime(0)
  updated_at DateTime @default(now()) @updatedAt @db.DateTime(0)
  created_by String   @db.VarChar(36)
  updated_by String   @db.VarChar(36)
  creator    user     @relation("faq_created_by", fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updater    user     @relation("faq_updated_by", fields: [updated_by], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([created_by], map: "faq_created_by_FK")
  @@index([updated_by], map: "faq_updated_by_FK")
  @@index([published], map: "faq_published_IDX")
}

/// ====== GUILDS ======
model guild {
  id        String         @id @default(uuid()) @db.Char(36)
  name      String         @db.VarChar(100)
  slug      String         @unique @db.VarChar(255)
  icon      String?        @db.Text
  ownerId   String         @db.VarChar(36)
  createdAt DateTime       @default(now()) @db.DateTime(0)
  updatedAt DateTime       @default(now()) @updatedAt @db.DateTime(0)
  channels  channel[]
  owner     user           @relation(fields: [ownerId], references: [id])
  members   guild_member[]
  room      room[]

  @@index([ownerId], map: "guild_owner_FK")
}

/// ====== GUILD MEMBERS ======
model guild_member {
  id       String   @id @default(uuid()) @db.Char(36)
  guildId  String   @db.Char(36)
  userId   String   @db.VarChar(36)
  nickname String?  @db.VarChar(100)
  roles    String?  @db.Text
  joinedAt DateTime @default(now()) @db.DateTime(0)
  guild    guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  user     user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([guildId, userId], map: "guild_member_unique")
  @@index([guildId], map: "guild_member_guild_idx")
  @@index([userId], map: "guild_member_user_idx")
}

/// ====== CHANNELS ======
model channel {
  id        String           @id @default(uuid()) @db.Char(36)
  guildId   String           @db.Char(36)
  name      String           @db.VarChar(100)
  slug      String           @db.VarChar(255)
  type      channel_type     @default(TEXT)
  topic     String?          @db.VarChar(500)
  position  Int              @default(0)
  isPrivate Boolean          @default(false)
  parentId  String?          @db.Char(36)
  createdAt DateTime         @default(now()) @db.DateTime(0)
  updatedAt DateTime         @default(now()) @updatedAt @db.DateTime(0)
  guild     guild            @relation(fields: [guildId], references: [id], onDelete: Cascade)
  parent    channel?         @relation("ChannelToChildren", fields: [parentId], references: [id])
  children  channel[]        @relation("ChannelToChildren")
  members   channel_member[]
  room      room?

  @@unique([guildId, slug], map: "channel_slug_per_guild")
  @@index([guildId], map: "channel_guild_idx")
  @@index([parentId], map: "channel_parent_idx")
}

/// Membres autorisés d’un channel privé
model channel_member {
  channelId String   @db.Char(36)
  userId    String   @db.VarChar(36)
  addedAt   DateTime @default(now()) @db.DateTime(0)
  channel   channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([channelId, userId])
  @@index([userId], map: "channel_member_user_idx")
}

/// ====== ROOMS ======
model room {
  id             String             @id @default(uuid()) @db.Char(36)
  type           room_type
  name           String?            @db.VarChar(255)
  ownerId        String?            @db.VarChar(36)
  guildId        String?            @db.Char(36)
  channelId      String?            @unique(map: "room_unique_channel") @db.Char(36)
  lastMessageAt  DateTime?          @db.DateTime(0)
  createdAt      DateTime           @default(now()) @db.DateTime(0)
  updatedAt      DateTime           @default(now()) @updatedAt @db.DateTime(0)
  dm_pair_unique dm_pair_unique[]
  messages       message[]
  channel        channel?           @relation(fields: [channelId], references: [id], onDelete: Cascade)
  guild          guild?             @relation(fields: [guildId], references: [id], onDelete: Cascade)
  owner          user?              @relation(fields: [ownerId], references: [id])
  participants   room_participant[]
  room_view      room_view[]

  @@index([type])
  @@index([guildId], map: "room_guild_idx")
  @@index([lastMessageAt])
  @@index([ownerId], map: "room_ownerId_fkey")
}

/// Participants
model room_participant {
  roomId   String   @db.Char(36)
  userId   String   @db.VarChar(36)
  joinedAt DateTime @default(now()) @db.DateTime(0)
  isMuted  Boolean  @default(false)
  isPinned Boolean  @default(false)
  room     room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user     user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomId, userId])
  @@index([userId], map: "room_participant_user_idx")
}

/// DMs (paire unique)
model dm_pair_unique {
  id     String @id @default(uuid()) @db.Char(36)
  userA  String @db.VarChar(36)
  userB  String @db.VarChar(36)
  roomId String @db.Char(36)
  room   room   @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([userA, userB], map: "dm_pair_users_unique")
  @@index([roomId], map: "dm_pair_room_idx")
}

/// ====== MESSAGES ======
model message {
  id          String             @id @default(uuid()) @db.Char(36)
  roomId      String             @db.Char(36)
  authorId    String             @db.VarChar(36)
  type        message_type       @default(TEXT)
  content     String?            @db.Text
  attachments String?            @db.Text
  createdAt   DateTime           @default(now()) @db.DateTime(0)
  editedAt    DateTime?          @db.DateTime(0)
  deletedAt   DateTime?          @db.DateTime(0)
  author      user               @relation(fields: [authorId], references: [id], onDelete: Cascade)
  room        room               @relation(fields: [roomId], references: [id], onDelete: Cascade)
  reactions   message_reaction[]
  reads       message_read[]

  @@index([roomId, createdAt, id], map: "message_room_created_id_idx")
  @@index([authorId, createdAt], map: "message_author_created_idx")
}

/// Accusés de lecture
model message_read {
  messageId String   @db.Char(36)
  userId    String   @db.VarChar(36)
  readAt    DateTime @default(now()) @db.DateTime(0)
  message   message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([messageId, userId])
  @@index([userId, readAt], map: "message_read_user_idx")
}

/// Réactions
model message_reaction {
  messageId String   @db.Char(36)
  userId    String   @db.VarChar(36)
  emoji     String   @db.VarChar(64)
  createdAt DateTime @default(now()) @db.DateTime(0)
  message   message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([messageId, userId, emoji])
  @@index([userId], map: "message_reaction_user_idx")
  @@index([messageId, emoji], map: "IX_message_emoji")
}

/// Vues de salon
model room_view {
  roomId     String   @db.Char(36)
  userId     String   @db.VarChar(36)
  lastSeenAt DateTime @default(now()) @db.DateTime(0)
  room       room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user       user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomId, userId])
  @@index([userId, lastSeenAt], map: "room_view_user_idx")
}

model OpenIddictApplications {
  Id                       String                     @id @db.VarChar(255)
  ApplicationType          String?                    @db.VarChar(50)
  ClientId                 String                     @unique(map: "IX_OpenIddictApplications_ClientId")
  ClientSecret             String?                    @db.LongText
  ClientType               String?                    @db.VarChar(50)
  ConcurrencyToken         String?                    @db.VarChar(50)
  ConsentType              String?                    @db.VarChar(50)
  DisplayName              String?                    @db.LongText
  DisplayNames             String?                    @db.LongText
  JsonWebKeySet            String?                    @db.LongText
  Permissions              String?                    @db.LongText
  PostLogoutRedirectUris   String?                    @db.LongText
  Properties               String?                    @db.LongText
  RedirectUris             String?                    @db.LongText
  Requirements             String?                    @db.LongText
  Settings                 String?                    @db.LongText
  OpenIddictAuthorizations OpenIddictAuthorizations[]
  OpenIddictTokens         OpenIddictTokens[]

  @@ignore
}

model OpenIddictAuthorizations {
  Id                     String                  @id @db.VarChar(255)
  ApplicationId          String?                 @db.VarChar(255)
  ConcurrencyToken       String?                 @db.VarChar(50)
  CreationDate           DateTime?               @db.DateTime(6)
  Properties             String?                 @db.LongText
  Scopes                 String?                 @db.LongText
  Status                 String?                 @db.VarChar(50)
  Subject                String?
  Type                   String?                 @db.VarChar(50)
  OpenIddictApplications OpenIddictApplications? @relation(fields: [ApplicationId], references: [Id], onDelete: NoAction, onUpdate: NoAction, map: "FK_OpenIddictAuthorizations_OpenIddictApplications_ApplicationId")
  OpenIddictTokens       OpenIddictTokens[]

  @@index([ApplicationId, Status, Subject, Type], map: "IX_OpenIddictAuthorizations_ApplicationId_Status_Subject_Type")
  @@ignore
}

model OpenIddictScopes {
  Id               String  @id @db.VarChar(255)
  ConcurrencyToken String? @db.VarChar(50)
  Description      String? @db.LongText
  Descriptions     String? @db.LongText
  DisplayName      String? @db.LongText
  DisplayNames     String? @db.LongText
  Name             String  @unique(map: "IX_OpenIddictScopes_Name")
  Properties       String? @db.LongText
  Resources        String? @db.LongText

  @@ignore
}

model OpenIddictTokens {
  Id                       String                    @id @db.VarChar(255)
  ApplicationId            String?                   @db.VarChar(255)
  AuthorizationId          String?                   @db.VarChar(255)
  ConcurrencyToken         String?                   @db.VarChar(50)
  CreationDate             DateTime?                 @db.DateTime(6)
  ExpirationDate           DateTime?                 @db.DateTime(6)
  Payload                  String?                   @db.LongText
  Properties               String?                   @db.LongText
  RedemptionDate           DateTime?                 @db.DateTime(6)
  ReferenceId              String?                   @unique(map: "IX_OpenIddictTokens_ReferenceId") @db.VarChar(100)
  Status                   String?                   @db.VarChar(100)
  Subject                  String?
  Type                     String?                   @db.VarChar(100)
  OpenIddictApplications   OpenIddictApplications?   @relation(fields: [ApplicationId], references: [Id], onDelete: NoAction, onUpdate: NoAction, map: "FK_OpenIddictTokens_OpenIddictApplications_ApplicationId")
  OpenIddictAuthorizations OpenIddictAuthorizations? @relation(fields: [AuthorizationId], references: [Id], onDelete: NoAction, onUpdate: NoAction, map: "FK_OpenIddictTokens_OpenIddictAuthorizations_AuthorizationId")

  @@index([ApplicationId, Status, Subject, Type], map: "IX_OpenIddictTokens_ApplicationId_Status_Subject_Type")
  @@index([AuthorizationId], map: "IX_OpenIddictTokens_AuthorizationId")
  @@ignore
}

model EFMigrationsHistory {
  MigrationId    String @id @db.VarChar(150)
  ProductVersion String @db.VarChar(32)

  @@map("__EFMigrationsHistory")
}

/// ====== ENAMS ======
enum room_type {
  DM
  GROUP
  GUILD_CHANNEL
}

enum channel_type {
  TEXT
  VOICE
  CATEGORY
}

enum message_type {
  TEXT
  SYSTEM
  EVENT
}
